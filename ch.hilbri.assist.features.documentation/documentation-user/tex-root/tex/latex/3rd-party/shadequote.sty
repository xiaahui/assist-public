% This package 'shadequotes' provides the shadequote environment
% as presented by Alan Munn at:
% http://tex.stackexchange.com/questions/16964/block-quote-with-big-quotation-marks

\ProvidesPackage{shadequote}[2014/08/06 v1.0 adaptation from stackexchange]

%
% PACKAGES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Detect high-tech processors ;-)
\RequirePackage{ifxetex,ifluatex}

% We need \ifblank{#1}
\RequirePackage{etoolbox}

% We need the "framed" environments, colors, and TikZ
\RequirePackage{framed}
\RequirePackage{xcolor}
\RequirePackage{tikz}

%
% FONTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Conditional for xetex or luatex
\newif\ifxetexorluatex
\ifxetex
  \xetexorluatextrue
\else
  \ifluatex
    \xetexorluatextrue
  \else
    \xetexorluatexfalse
  \fi
\fi

% Define \quotefont to be nice Libertine quotes
\ifxetexorluatex%
  \usepackage{fontspec}
  %\usepackage{libertine} % or use \setmainfont to choose any font on your system
  \newfontfamily\quotefont[Ligatures=TeX]{Linux Libertine O} % selects Libertine as the quote font
\else
  %\usepackage[utf8]{inputenc}
  %\usepackage[T1]{fontenc}
  %\usepackage{libertine} % or any other font package
  \newcommand\quotefont{\fontfamily{LinuxLibertineT-LF}} % selects Libertine as the quote font
\fi

% Define \quotesize to be quite big
\newcommand\quotesize{60} % if quote size changes, need a way to make shifts relative

% Select a colour for the shading
\colorlet{shadecolor}{black!20}

% Select a colour for the quotes
\colorlet{quotecolor}{black}

% Define the formatting of the author
\newcommand\shadedauthorformat{\emph} % define format for the author argument

%
% QUOTES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Make commands for the quotes
\newcommand{\openquote}%
   {\tikz[remember picture,overlay,xshift=-4ex,yshift=-2.5ex,color=quotecolor]%
   \node (OQ) {\quotefont\fontsize{\quotesize}{\quotesize}\selectfont``};\kern0pt}
\newcommand{\closequote}[1]%
  {\tikz[remember picture,overlay,xshift=4ex,yshift={#1},color=quotecolor]%
   \node (CQ) {\quotefont\fontsize{\quotesize}{\quotesize}\selectfont''};}


%
% ENVIRONMENT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Now a command to allow left, right and centre alignment of the author
\newcommand*\authoralign[1]{%
  \if#1l%
    \def\authorfill{}\def\quotefill{\hfill}%
  \else%
    \if#1r%
      \def\authorfill{\hfill}\def\quotefill{}%
    \else%
      \if#1c%
        \gdef\authorfill{\hfill}\def\quotefill{\hfill}%
      \else\typeout{Invalid option}%
      \fi%
    \fi%
  \fi}

% wrap everything in its own environment which takes one argument (author) and one optional argument
% specifying the alignment [l, r or c]
%
\newenvironment{shadequote}[2][l]%
{%
  \authoralign{#1}%
  \ifblank{#2}%
    {\def\shadequoteauthor{}\def\yshift{-2ex}\def\quotefill{\hfill}}%
    {\def\shadequoteauthor{\par\authorfill\shadedauthorformat{#2}}\def\yshift{2ex}}%
  \begin{snugshade}\begin{quote}\openquote\vphantom{pf}\ignorespaces%
}
{\shadequoteauthor\quotefill\closequote{\yshift}\end{quote}\end{snugshade}}
